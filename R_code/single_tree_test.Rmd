---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)

single_tree_data =  read_tsv("/Users/noa/Workspace/raxml_deep_learning_results/ready_raw_data/Pandit/ML/ready/test_single_tree_data.tsv")

```

```{r}
single_tree_data %>% distinct (msa_path, feature_msa_pypythia_msa_difficulty)
```

```{r}
single_tree_data  %>% ggplot(aes(x=predicted_time, y= as.factor(is_global_max)))+geom_boxplot()
```


```{r}
data<-single_tree_data %>%arrange(predicted_time) %>% select (msa_path, predicted_uncalibrated_failure_probabilities,predicted_calibrated_failure_probabilities,starting_tree_type, starting_tree_ind, spr_radius, spr_cutoff, feature_mds_False_pca_0_3_spr_enriched, delta_ll_from_overall_msa_best_topology, is_global_max,tree_clusters_ind, predicted_time, feature_mds_False_stress_3_spr_enriched, feature_msa_pypythia_msa_difficulty,feature_msa_n_seq) %>% group_by(msa_path,starting_tree_ind, starting_tree_type)  %>% filter (row_number()==1) %>% ungroup() 

#arrange(predicted_uncalibrated_failure_probabilities) 

global_data<-data %>% group_by(msa_path)  %>% arrange(predicted_uncalibrated_failure_probabilities) %>% mutate(row_num = row_number(), total_prob = 1-cumprod(1-predicted_calibrated_failure_probabilities)) %>% ungroup() %>% filter (is_global_max==1) %>% group_by(msa_path) %>% filter (row_num == min(row_num)) %>% select (row_num,total_prob,feature_mds_False_stress_3_spr_enriched, feature_msa_pypythia_msa_difficulty,feature_msa_n_seq)

global_data

global_data%>% ggplot(aes(x=row_num))+geom_histogram()

global_data%>% ggplot(aes(x=total_prob, y =feature_mds_False_stress_3_spr_enriched ))+geom_point()
global_data%>% ggplot(aes(y=total_prob, x =feature_msa_pypythia_msa_difficulty ))+geom_point()
global_data%>% ggplot(aes(y=row_num, x =feature_msa_pypythia_msa_difficulty ))+geom_point()
global_data%>% ggplot(aes(y=row_num, x =total_prob ))+geom_point()

global_data%>% ggplot(aes(y=total_prob, x =feature_msa_n_seq ))+geom_point()
cor.test(global_data %>% pull (total_prob), global_data %>% pull (feature_msa_pypythia_msa_difficulty))
cor.test(global_data %>% pull (total_prob), global_data %>% pull (feature_msa_n_seq))





 



#data  %>% group_by(msa_path) %>% mutate(global_max = max(is_global_max)) %>% filter (global_max==0) %>% distinct (msa_path) %>% #arrange(msa_path)

"/groups/pupko/noaeker/data/New_MSAs/Pandit_msas/PF00122.fasta"
"/groups/pupko/noaeker/data/New_MSAs/Pandit_msas/PF00061.fasta"


```
```{r}
global_data %>% ggplot(aes(x= total_prob))+geom_histogram(bins =3)
global_data%>% ggplot(aes(y=row_num, x =total_prob ))+geom_point()
data %>% distinct (msa_path)
```


```{r}
data %>% filter(msa_path=="/groups/pupko/noaeker/data/New_MSAs/Pandit_msas/PF07994.fasta")  %>% arrange(predicted_uncalibrated_failure_probabilities) %>% mutate(row_num = row_number(), total_prob = 1-cumprod(1-predicted_uncalibrated_failure_probabilities)) %>% ungroup() %>% select (total_prob, predicted_uncalibrated_failure_probabilities, is_global_max, delta_ll_from_overall_msa_best_topology)
```



```{r}
single_tree_data %>% filter (msa_path=="/groups/pupko/noaeker/data/New_MSAs/Pandit_msas/PF00122.fasta") %>%
  group_by(starting_tree_ind,starting_tree_type) %>% mutate(max_global= max(is_global_max)) %>% ungroup() %>% filter (max_global==1) %>%
  arrange(starting_tree_ind,predicted_uncalibrated_failure_probabilities) %>% select (starting_tree_type, starting_tree_ind,is_global_max,predicted_time,predicted_uncalibrated_failure_probabilities,, spr_radius, spr_cutoff, feature_mds_False_pca_0_3_spr_enriched, delta_ll_from_overall_msa_best_topology, is_global_max,tree_clusters_ind, predicted_time) 
```


```{r}
data<-single_tree_data %>% arrange(predicted_uncalibrated_failure_probabilities) %>% select (msa_path,predicted_uncalibrated_failure_probabilities,starting_tree_type, starting_tree_ind, spr_radius, spr_cutoff, feature_mds_False_pca_0_3_spr_enriched, delta_ll_from_overall_msa_best_topology, is_global_max,tree_clusters_ind, predicted_time) %>% group_by(msa_path, starting_tree_type, starting_tree_ind) %>% group_by(starting_tree_ind, starting_tree_type)  %>% filter (row_number()==1)
```


```{r}
library(randomForest)

test_msas<-global_data %>% distinct(msa_path)
train_msas<-

data.rf<-randomForest(total_prob~feature_msa_pypythia_msa_difficulty+total_prob+feature_mds_False_stress_3_spr_enriched, data = global_data)

data.rf
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

