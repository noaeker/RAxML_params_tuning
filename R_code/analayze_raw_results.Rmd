---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 
```{r}
library(tidyverse)
library(survival)
library(survminer)
library(cmprsk)
library(tidyverse)
library(caret)
library(survival)
library(survminer)
library(lubridate)
```

```{r}


raw_data = read_tsv("/Users/noa/Workspace/raxml_deep_learning_results/ready_raw_data/all_data/ML_edited_features.tsv")
raw_data <- raw_data %>% mutate(normalized_time = elapsed_running_time/test_norm_const) %>% mutate(is_global_max_str=ifelse(delta_ll_from_overall_msa_best_topology==0,"Global-maximum","Local-maximum"), is_global_max_num =ifelse(delta_ll_from_overall_msa_best_topology==0,1,2) )  %>%  mutate(is_global_max_str = as_factor(is_global_max_str)) 


```



```{r}

library(cmprsk)
default_data= read_tsv("/Users/noa/Workspace/raxml_deep_learning_results/ready_raw_data/all_data/default_sampling.tsv")
default_data<- default_data %>% mutate(curr_sample_is_global_max=ifelse(curr_sample_is_global_max==0,"Local-maximum","Global-maximum"))

fit<-cuminc(
    ftime = default_data$curr_sample_total_time, 
    fstatus = default_data$curr_sample_is_global_max, 
    cencode = 0,
    #group =  default_data$starting_tree_type
    )
ggcompetingrisks(fit = fit, multiple_panels = FALSE,  xlab = "Time to event", ylab = "Cumulative incidence of event",title = "Competing Risks Analysis")#+scale_color_manual(name="", values=c("blue","red"), labels=c("Local maxima", "Global maxima"))

summary(fit)

```



```{r}
library(cmprsk)
msas = raw_data %>% distinct (msa_path) %>% pull(msa_path)
example_msa = pluck(msas,130)
first_msa_default <- raw_data %>% filter(type=="default",msa_path==example_msa) #msa_path==example_msa, 
fit<-cuminc(
    ftime = first_msa_default $normalized_relative_time, 
    fstatus = first_msa_default $is_global_max_str, 
    cencode = 0,
    group = first_msa_default$starting_tree_type
    )
ggcompetingrisks(fit = fit, multiple_panels = FALSE,  xlab = "Time to event", ylab = "Cumulative incidence of event",title = "Competing Risks Analysis")#+scale_color_manual(name="", values=c("blue","red"), labels=c("Local maxima", "Global maxima"))

summary(fit)
```



```{r}
library(cmprsk)
res.cox <- coxph(formula=Surv(normalized_relative_time, is_global_max_num) ~ spr_radius+spr_cutoff+starting_tree_type, data = raw_data)
summary(res.cox)
```

```{r}
fit <- survfit(res.cox, data = raw_data)
ggsurvplot(fit, conf.int = TRUE,
           ggtheme = theme_minimal())
```


```{r}
# library(randomForestSRC)
# raw_data[sapply(raw_data, is.character)] <- lapply(raw_data[sapply(raw_data, is.character)], 
#                                                            as.factor)
# 
# is_global_max <- as.factor(raw_data$is_global_max)
# first_msa<- raw_data %>% filter(msa_path== example_msa, spr_cutoff==1, spr_radius==5)
# o <- rfsrc.fast(Surv(normalized_time,is_global_max) ~. , data = as.data.frame(first_msa), importance = TRUE)
# print(o)
# plot(get.tree(o, 3))
pdf("follic.pdf", width = 8, height = 8)
par(cex.axis = 2.0, cex.lab = 2.0, cex.main = 2.0, mar = c(6.0,6,1,1), mgp = c(4, 1, 0))
plot.competing.risk(o)
dev.off()
```







```{r}
library(InformationValue)

msas = raw_data %>% distinct (msa_path) %>% pull(msa_path)
test_sampled_msas = msas[sample(1:length(msas),3)]
test<-  raw_data %>% filter (msa_path %in% test_sampled_msas)
train<-  raw_data %>% filter (!(msa_path %in% test_sampled_msas))

#sample <- sample(c(TRUE, FALSE), nrow(raw_data_with_features), replace=TRUE, prob=c(0.7,0.3))
#train <- raw_data_with_features[sample, ]
#test <- raw_data_with_features[!sample, ] 


bin_glm<-  glm(is_global_max ~ feature_n_seq + feature_n_loci +spr_radius+
                + spr_cutoff+starting_tree_type+feature_constant_sites_pct+feature_gap_positions_pct+ starting_tree_ll+feature_mean_rf_distance+ +feature_max_rf_distance+feature_tree_divergence+feature_tree_MAD+feature_largest_branch_length+feature_largest_distance_between_taxa+feature_mean_rf_distance, data = train, family = "binomial")
caret::varImp(bin_glm)

nullmod <- glm(is_global_max ~1,data = train , family="binomial")
r2 = 1-logLik(bin_glm)/logLik(nullmod)
print(r2)
summary(bin_glm)


```

```{r}
test_predictions<- predict(bin_glm, test, type="response")

optimal <- optimalCutoff(test$is_global_max ,test_predictions)[1]

confusionMatrix(test$is_global_max ,test_predictions)

sensitivity(test$is_global_max ,test_predictions)
specificity(test$is_global_max ,test_predictions)
misClassError(test$is_global_max ,test_predictions)
plotROC(test$is_global_max ,test_predictions)
```



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

