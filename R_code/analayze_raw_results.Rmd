---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
raw_data = read_tsv("/Users/noa/Workspace/raxml_deep_learning_results/c_30_70/features.tsv")

```







```{r}
raw_data <- raw_data %>% mutate(normalized_time = elapsed_running_time/test_norm_const) %>% mutate(is_global_max=delta_ll_from_overall_msa_best_topology==0)  %>% filter (type!="default")

agg_data_non_default<- raw_data %>% filter (type!="default") %>% group_by(msa_path,spr_radius,spr_cutoff,starting_tree_type, feature_n_seq, feature_n_loci,feature_mean_rf_distance, feature_constant_sites_pct, feature_gap_positions_pct) %>% summarize (mean_global = mean(delta_ll_from_overall_msa_best_topology==0), sum_global = sum(delta_ll_from_overall_msa_best_topology==0) , mean_time = mean(normalized_time) ) %>% ungroup()


msas = agg_data_non_default %>% distinct (msa_path) %>% pull(msa_path)
example_msa = pluck(msas,20)
agg_data_non_default %>% filter(msa_path==example_msa) %>% ggplot(aes(y=mean_global, x = spr_radius, color = starting_tree_type )) + geom_point(size =1)+ geom_line()+ facet_grid(rows = vars(spr_cutoff))+expand_limits( y = 0)

```



```{r}
library(InformationValue)

msas = raw_data %>% distinct (msa_path) %>% pull(msa_path)
test_sampled_msas = msas[sample(1:length(msas),3)]
test<-  raw_data %>% filter (msa_path %in% test_sampled_msas)
train<-  raw_data %>% filter (!(msa_path %in% test_sampled_msas))

#sample <- sample(c(TRUE, FALSE), nrow(raw_data_with_features), replace=TRUE, prob=c(0.7,0.3))
#train <- raw_data_with_features[sample, ]
#test <- raw_data_with_features[!sample, ] 


bin_glm<-  glm(is_global_max ~ feature_n_seq + feature_n_loci +spr_radius+
                + spr_cutoff+starting_tree_type+feature_constant_sites_pct+feature_gap_positions_pct+ starting_tree_ll+feature_mean_rf_distance+ +feature_max_rf_distance+feature_tree_divergence+feature_tree_MAD+feature_largest_branch_length+feature_largest_distance_between_taxa+feature_mean_rf_distance, data = train, family = "binomial")
caret::varImp(bin_glm)

nullmod <- glm(is_global_max ~1,data = train , family="binomial")
r2 = 1-logLik(bin_glm)/logLik(nullmod)
print(r2)
summary(bin_glm)


```

```{r}
test_predictions<- predict(bin_glm, test, type="response")

optimal <- optimalCutoff(test$is_global_max ,test_predictions)[1]

confusionMatrix(test$is_global_max ,test_predictions)

sensitivity(test$is_global_max ,test_predictions)
specificity(test$is_global_max ,test_predictions)
misClassError(test$is_global_max ,test_predictions)
plotROC(test$is_global_max ,test_predictions)
```



Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

