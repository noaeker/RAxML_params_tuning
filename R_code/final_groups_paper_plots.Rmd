---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(ggpubr)
library(pROC)
```
```{r}

prefix = "/Users/noa/Workspace/raxml_deep_learning_results/new_grouping_test/Data_for_paper"
current_run ="groups_10_10_100"
error_vs_size_path = paste(prefix,current_run,"group_classification_metrics.tsv", sep = "/")
error_vs_group_path = paste(prefix,current_run,"group_classification_group_metrics.tsv",sep = "/")
test_path = paste(prefix,current_run,"final_performance_on_test.tsv",sep = "/")

error_vs_size = read_tsv(error_vs_size_path)
test_data = read_tsv(test_path)
error_vs_group = read_tsv(error_vs_group_path )
```

AUC + error vs. siz plots

```{r}
error_vs_size_plt = error_vs_size %>% mutate(n_MSAs = round(868*sample_fraction)) %>% ggplot(aes(x=n_MSAs, y = AUC))+geom_line()+ expand_limits(y = 0.5)+xlab("Number of MSAs")+ theme(text = element_text(size = 13))+ylab("AUC")+geom_point()

rocobj <- roc(test_data$default_status, test_data$uncalibrated_prob)
auc <- round(auc(test_data$default_status, test_data$uncalibrated_prob),3)

global_max_auc_plt<-ggroc(rocobj,colour = 'steelblue', size = 2)+
  ggtitle(paste0('AUC = ', auc))+theme(text = element_text(size = 13))+xlab("Specificity")

ggarrange(global_max_auc_plt,error_vs_size_plt ,labels = c("A","B"),align = "h", nrow = 1, ncol = 2, legend = "bottom",vjust= 1)

test_data%>% group_by (default_status) %>% count()



```



```{r}

Pypythia_error<-error_vs_group %>% filter (grouping_col_name =='msa_difficulty_group') %>% ggplot(aes(y=grouping_col, x=AUC))+geom_col()+ expand_limits(y = c(0.5,1))+ylab('MSA difficulty')+ xlab('AUC')+theme(text = element_text(size = 11))


n_seq_error<-error_vs_group %>% filter (grouping_col_name =='n_seq_group') %>% ggplot(aes(y=grouping_col, x=AUC))+geom_col()+ expand_limits(y = c(0.5,1))+ylab('Number of sequences')+xlab('AUC')+theme(text = element_text(size = 11))


Pypythia_scatter<-test_data%>% select (msa_path,uncalibrated_prob,calibrated_prob, feature_mds_pars, feature_msa_pypythia_msa_difficulty) %>% group_by(msa_path,feature_msa_pypythia_msa_difficulty,feature_mds_pars) %>% summarise(mean_prob = mean(calibrated_prob)) %>% ggplot(aes(x=feature_msa_pypythia_msa_difficulty, y = mean_prob))+geom_point()+xlab("MSA difficulty")+ylab("Predicted probability")+theme(text = element_text(size = 11))

seq_scatter<-test_data %>% select (msa_path,uncalibrated_prob,calibrated_prob, feature_mds_pars, feature_msa_n_seq, feature_msa_pypythia_msa_difficulty) %>% group_by(msa_path,feature_msa_n_seq,feature_msa_pypythia_msa_difficulty,feature_mds_pars) %>% summarise(mean_prob = mean(calibrated_prob)) %>% ggplot(aes(x=feature_msa_n_seq, y = mean_prob))+geom_point()+xlab("Number of sequences")+ylab("Predicted probability")+theme(text = element_text(size = 11))


ggarrange(n_seq_error, seq_scatter,Pypythia_error,Pypythia_scatter,labels = c("A","B","C","D"),align = "h", nrow = 2, ncol = 2, legend = "bottom",vjust= 1)
#error_vs_group_5_5_including_plt


```


MDS vs PARS dist
```{r}

test_data %>% select (msa_path,uncalibrated_prob,calibrated_prob, feature_mds_pars, feature_msa_n_seq, feature_msa_pypythia_msa_difficulty) %>% group_by(msa_path,feature_msa_n_seq,feature_msa_pypythia_msa_difficulty,feature_mds_pars) %>% summarise(mean_prob = mean(calibrated_prob)) %>% ggplot(aes(x=log(feature_mds_pars), y = mean_prob))+geom_point()+xlab("MDS stress score")+ylab("Mean predicted success probability")+theme(text = element_text(size = 13))


test_data %>% select (msa_path,uncalibrated_prob,calibrated_prob, feature_mds_pars, feature_msa_n_seq, feature_pars_dist, feature_msa_pypythia_msa_difficulty) %>% group_by(msa_path,feature_msa_n_seq,feature_msa_pypythia_msa_difficulty,feature_mds_pars,feature_pars_dist) %>% summarise(mean_prob = mean(calibrated_prob)) %>% ggplot(aes(x=feature_pars_dist, y = mean_prob))+geom_point()+xlab("Pars dist")+ylab("Mean predicted success probability")+theme(text = element_text(size = 13))

```







Testing the MDS score

```{r}
test_data_including %>% group_by(msa_path, feature_mds_pars,feature_msa_pypythia_msa_difficulty) %>% summarise(mean_success = mean(default_status)) %>% ggplot(aes(x=(feature_msa_pypythia_msa_difficulty), y = mean_success))+geom_point()

test_data_including %>% group_by(msa_path, feature_mds_pars,feature_msa_pypythia_msa_difficulty) %>% summarise(mean_success = mean(default_status)) %>% ggplot(aes(x=log(feature_mds_pars), y = mean_success))+geom_point()

test_data_including %>% group_by(msa_path, feature_mds_pars,feature_msa_pypythia_msa_difficulty,feature_pars_dist) %>% summarise(mean_success = mean(default_status)) %>% ggplot(aes(x=feature_pars_dist, y = mean_success))+geom_point()

data<-test_data_including %>% mutate(log_mds = log(feature_mds_pars)) %>% group_by(msa_path,feature_mds_pars, feature_pars_dist,feature_msa_pypythia_msa_difficulty, log_mds) %>% summarise(mean_success = mean(default_status)) 

cor(data %>% pull ((feature_mds_pars)),data %>% pull (mean_success))
cor(data %>% pull ((log_mds)),data %>% pull (mean_success))
cor(data %>% pull (feature_pars_dist),data %>% pull (mean_success))
```






`




Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

